<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Trial of Precision</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Cinzel', serif;
            background: #1a1a1a;
            color: #f0f0f0;
            overflow: hidden;
        }
        
        #gameContainer {
            width: 100vw;
            height: 100vh;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        #gameScreen {
            width: 95vw;
            max-width: 1200px;
            height: 90vh;
            background: linear-gradient(45deg, #2c1810, #1a0f0a);
            border: 3px solid #8b4513;
            border-radius: 15px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 0 30px rgba(139, 69, 19, 0.5);
        }
        
        .screen {
            position: absolute;
            width: 100%;
            height: 100%;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
        }
        
        .screen.active {
            display: flex;
        }
        
        .title {
            font-size: 2.2rem;
            color: #d4af37;
            margin-bottom: 2rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            font-weight: 600;
        }
        
        .subtitle {
            font-size: 1.5rem;
            color: #c9c9c9;
            margin-bottom: 2rem;
            line-height: 1.6;
        }
        
        .button {
            background: linear-gradient(45deg, #8b4513, #a0522d);
            border: 2px solid #d4af37;
            color: #f0f0f0;
            padding: 15px 30px;
            font-size: 1.2rem;
            font-family: 'Cinzel', serif;
            cursor: pointer;
            border-radius: 8px;
            margin: 10px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        
        .button:hover {
            background: linear-gradient(45deg, #a0522d, #cd853f);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.4);
        }
        
        .button.secondary {
            padding: 10px 20px;
            font-size: 0.9rem;
            background: linear-gradient(45deg, #6c757d, #495057);
            border-color: #adb5bd;
        }
        
        .button.secondary:hover {
            background: linear-gradient(45deg, #495057, #343a40);
            border-color: #6c757d;
        }
        
        #level1Game {
            background: linear-gradient(135deg, #2c2416, #1a1409);
            position: relative;
        }
        
        #player {
            position: absolute;
            bottom: 30%;
            left: 20%;
            width: 60px;
            height: 80px;
            background: #8b4513;
            border-radius: 5px 5px 0 0;
            transition: all 0.3s ease;
        }
        
        #player::before {
            content: '';
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 20px;
            height: 20px;
            background: #deb887;
            border-radius: 50%;
        }
        
        #player::after {
            content: '⚔️';
            position: absolute;
            right: -15px;
            top: 20px;
            font-size: 20px;
        }
        
        #rock {
            position: absolute;
            bottom: 25%;
            right: 25%;
            width: 240px; /* Was 120px */
            height: 200px; /* Was 100px */
            cursor: pointer;
            transition: all 0.3s ease;
            object-fit: contain; /* Ensure image scales well */
        }
        
        #rock:hover {
            transform: scale(1.05);
        }
        
        #interactionPrompt {
            position: absolute;
            bottom: 15%;
            right: 20%;
            background: rgba(0,0,0,0.8);
            color: #d4af37;
            padding: 10px 15px;
            border-radius: 5px;
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        #carvingGame {
            background: rgba(0,0,0,0.9);
            z-index: 100;
        }
        
        #carvingCanvas {
            border: 3px solid #d4af37;
            background: #696969;
            cursor: crosshair;
            border-radius: 10px;
        }
        
        #precisionMeter {
            width: 30px;
            height: 200px;
            background: #333;
            border: 2px solid #d4af37;
            border-radius: 15px;
            margin-left: 30px;
            position: relative;
            overflow: hidden;
        }
        
        #precisionFill {
            position: absolute;
            bottom: 0;
            width: 100%;
            background: linear-gradient(to top, #ff4444, #ffff44, #44ff44);
            transition: height 0.3s ease;
            border-radius: 0 0 13px 13px;
        }
        
        #level2Doors {
            background: linear-gradient(180deg, #1a1a2e, #16213e);
            justify-content: space-around;
            flex-direction: row;
        }
        
        .door {
            width: 120px;
            height: 200px;
            border-radius: 15px 15px 0 0;
            cursor: pointer;
            position: relative;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
        }
        
        .door:hover {
            transform: scale(1.05) translateY(-2px);
        }
        
        .door-handle {
            width: 15px;
            height: 40px;
            background: #c0c0c0;
            border: 1px solid #808080;
            border-radius: 3px;
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
        }
        
        @keyframes subtleDrift {
            0% { transform: translate(0, 0) rotate(0deg); }
            25% { transform: translate(15px, 10px) rotate(3deg); }
            50% { transform: translate(0, 20px) rotate(0deg); }
            75% { transform: translate(-15px, 10px) rotate(-3deg); }
            100% { transform: translate(0, 0) rotate(0deg); }
        }

        .drifting-door {
            animation: subtleDrift 2s ease-in-out infinite;
            position: absolute;
        }
        
        #leftDoor {
            background: linear-gradient(45deg, #8B4513, #A0522D);
            color: #ff6b6b;
            border: 3px solid #5D3A1A;
        }
        
        #rightDoor {
            background: linear-gradient(45deg, #8B4513, #A0522D);
            color: #90ee90;
            border: 3px solid #5D3A1A;
        }
        
        #level3Hub {
            background: linear-gradient(135deg, #4a5568, #2d3748);
            flex-direction: column;
        }

        #level3HubImage {
            display: block;
            margin: 0 auto 1rem auto; /* Centered with bottom margin */
            max-height: 150px; /* Adjust as needed */
            max-width: 80%;    /* Responsive width */
            object-fit: contain; /* Maintain aspect ratio */
        }
        
        .trials-container {
            display: flex;
            justify-content: space-around;
            width: 100%;
            margin-top: 2rem;
        }
        
        .trial {
            width: 150px;
            height: 150px;
            background: linear-gradient(45deg, #2b6cb0, #3182ce);
            border: 3px solid #d4af37;
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 2rem;
            color: #f0f0f0;
        }
        
        .trial:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
        }
        
        .trial.completed {
            background: linear-gradient(45deg, #38a169, #48bb78);
            border-color: #68d391;
        }
        
        .trial-name {
            font-size: 0.8rem;
            margin-top: 10px;
        }
        
        #speedTrial, #strengthTrial, #swordDuel {
            background: linear-gradient(135deg, #2d3748, #1a202c);
        }
        
        #speedTrack {
            width: 100%;
            height: 100px;
            background: linear-gradient(90deg, #4a5568, #2d3748);
            border: 2px solid #d4af37;
            border-radius: 10px;
            position: relative;
            overflow: hidden;
            margin: 20px 0;
        }
        
        .runner {
            position: absolute;
            bottom: 10px;
            width: 50px; /* Changed from 60px */
            height: 50px; /* Changed from 80px to make it square */
            transition: left 0.1s linear;
            display: flex; /* Added for centering content */
            align-items: center; /* Added for centering content */
            justify-content: center; /* Added for centering content */
            font-size: 28px; /* Adjust emoji size as needed */
            border: 2px solid #d4af37; /* Optional: add a border */
            border-radius: 5px; /* Optional: slight rounding */
        }

        .runner img { /* This rule might become obsolete or removed if no images are used */
            /* width: 100%; */
            /* height: 100%; */
            /* object-fit: contain; */ 
        }

        #playerRunner {
            background: #8b4513; /* Existing player color */
            color: #fff; /* Ensure emoji is visible */
        }
        
        #npcRunner {
            background: #4169e1; /* Existing NPC color */
            color: #fff; /* Ensure emoji is visible */
            left: 0%;
        }
        
        #combatArena {
            width: 400px;
            height: 300px;
            background: #2d3748;
            border: 3px solid #d4af37;
            border-radius: 15px;
            position: relative;
            margin: 20px 0;
        }
        
        .enemy {
            position: absolute;
            width: 30px;
            height: 30px;
            background: #dc143c;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .enemy:hover {
            transform: scale(1.2);
        }
        
        #playerCombat {
            position: absolute;
            bottom: 50%;
            left: 50%;
            transform: translate(-50%, 50%);
            width: 40px;
            height: 40px;
            background: #8b4513;
            border-radius: 50%;
        }
        
        #bossArena {
            width: 500px;
            height: 400px;
            background: #1a202c;
            border: 3px solid #d4af37;
            border-radius: 20px;
            position: relative;
            margin: 10px 0;
        }
        
        #giantHealthDisplayArea {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 15px;
            width: 100%;
        }
        
        #giantStatus {
            font-size: 1rem;
            color: #d4af37;
            background: rgba(0,0,0,0.6);
            padding: 8px 15px;
            border-radius: 8px;
            z-index: 10;
            margin-bottom: 8px;
            text-align: center;
        }
        
        #giant {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 120px; /* Adjust width as needed for the image */
            height: 150px; /* Adjust height as needed for the image */
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 1;
        }

        #giant img {
            width: 100%;
            height: 100%;
            object-fit: contain; /* Or cover */
            border-radius: 10px; /* Optional: if you want rounded corners on the image itself */
        }
        
        #giantHealthHearts {
            font-size: 1.8rem;
            display: flex;
            gap: 8px;
            background: rgba(0, 0, 0, 0.6);
            padding: 8px 15px;
            border-radius: 8px;
            border: 2px solid #d4af37;
            z-index: 10;
        }
        
        .heart {
            color: #ff4444;
            transition: all 0.3s ease;
        }
        
        .heart.empty {
            color: #666;
            transform: scale(0.8);
        }
        
        #giant::after {
            content: '⚔️';
            position: absolute;
            top: -40px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 2rem;
            opacity: 0;
            transition: all 0.3s ease;
            pointer-events: none;
        }
        
        #giant:hover::after {
            opacity: 1;
            top: -50px;
        }
        
        #giant.attackable {
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }
        
        #giant.attackable:hover {
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.8);
        }
        
        .sword-pickup {
            position: absolute;
            width: 30px;
            height: 30px;
            background: #ffd700;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .sword-pickup:hover {
            transform: scale(1.2);
        }

        /* Styles for sword pickup image if different from default .sword-image-style */
        .sword-pickup-image {
            width: 100%; /* Make image fill the .sword-pickup div */
            height: 100%;
            object-fit: contain;
        }
        
        #level4Altar {
            background: linear-gradient(135deg, #4c1d95, #5b21b6);
        }
        
        #altar {
            width: 200px;
            height: 100px;
            background: linear-gradient(45deg, #94a3b8, #cbd5e1);
            border-radius: 20px;
            margin: 20px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        #altar:hover {
            box-shadow: 0 0 30px rgba(212, 175, 55, 0.8);
        }
        
        #finalDoor {
            width: 300px;
            height: 400px;
            background: linear-gradient(45deg, #d4af37, #ffd700);
            border: 5px solid #b8860b;
            border-radius: 30px 30px 0 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            cursor: pointer;
            transition: all 0.5s ease;
        }
        
        #finalDoor:hover {
            box-shadow: 0 0 50px rgba(255, 215, 0, 0.8);
        }
        
        #paradise {
            background: linear-gradient(135deg, #10b981, #34d399, #6ee7b7);
            color: #065f46;
        }
        
        .paradise-text {
            background: rgba(255,255,255,0.9);
            padding: 20px;
            border-radius: 15px;
            color: #065f46;
            margin: 10px 0;
        }
        
        .ui-info {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0,0,0,0.7);
            padding: 10px 15px;
            border-radius: 8px;
            color: #d4af37;
            font-size: 14px;
        }
        
        .ui-inventory {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.7);
            padding: 10px 15px;
            border-radius: 8px;
            color: #d4af37;
            font-size: 14px;
        }
        
        .progress-bar {
            width: 300px;
            height: 20px;
            background: #333;
            border: 2px solid #d4af37;
            border-radius: 10px;
            margin: 10px 0;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #dc143c, #ffd700, #32cd32);
            transition: width 0.3s ease;
            border-radius: 8px;
        }
        
        .floating-text {
            position: absolute;
            color: #d4af37;
            font-weight: bold;
            pointer-events: none;
            animation: floatUp 2s ease-out forwards;
        }
        
        @keyframes floatUp {
            0% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-50px); }
        }
        
        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: #ffd700;
            border-radius: 50%;
            pointer-events: none;
            animation: sparkle 1s ease-out forwards;
        }
        
        @keyframes sparkle {
            0% { opacity: 1; transform: scale(1); }
            100% { opacity: 0; transform: scale(2); }
        }

        #chippableRockContainer {
            position: relative;
            width: 200px;
            height: 200px;
            margin: 30px auto;
            cursor: pointer;
        }

        #chippableRock {
            width: 100%;
            height: 100%;
            background: #5a4a3a;
            border-radius: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 5rem;
            color: #8b4513;
            text-align: center;
            transition: transform 0.1s ease, box-shadow 0.1s ease;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
            user-select: none;
        }

        #chippableRock:active {
            transform: scale(0.95);
            box-shadow: inset 0 0 30px rgba(0,0,0,0.7);
        }

        .rock-chip {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #8b5a2b;
            border-radius: 50%;
            pointer-events: none;
            animation: flyOff 0.5s ease-out forwards;
        }

        @keyframes flyOff {
            0% { transform: translate(0, 0) scale(1); opacity: 1; }
            100% { transform: translate(var(--tx, 0px), var(--ty, -50px)) scale(0); opacity: 0; }
        }

        .key-image-style {
            width: 24px;
            height: auto;
            vertical-align: middle;
            margin-left: 5px;
        }

        #chippableRock img.key-image-style {
            width: 100px;
            height: auto;
        }

        #finalDoorScreen .key-image-style {
            width: 50px; /* Size on the final door */
            height: auto;
            margin-top: 10px;
        }

        .sword-image-style {
            height: 20px; /* Default height, adjust as needed */
            width: auto;
            vertical-align: middle;
            margin: 0 2px; /* Small margin around it */
        }

        /* For larger sword icons like pickups or prominent displays */
        .sword-image-style.large {
            height: 30px;
        }

        /* For icons within trial buttons */
        .trial-icon-image {
            height: 40px; /* Adjust to fit well in trial buttons */
            width: auto;
            margin-bottom: 5px; /* Space below icon, above text */
        }

        #strengthTrial {
            background: linear-gradient(135deg, #4a5568, #2d3748);
            flex-direction: column;
            justify-content: flex-start;
            padding-top: 20px;
        }

        #strengthTrialInfo {
            font-size: 1rem;
            color: #d4af37;
            background: rgba(0,0,0,0.6);
            padding: 8px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
            width: auto;
            align-self: center;
        }

        #combatArena {
            width: 400px;
            height: 300px;
            background: #2d3748;
            border: 3px solid #d4af37;
            border-radius: 15px;
            position: relative;
            margin: 20px 0;
        }

        @media (max-width: 768px) {
            .title {
                font-size: 1.8rem; /* Further reduce title size on small screens */
                margin-bottom: 1rem;
            }

            #gameScreen {
                border-width: 2px;
                border-radius: 10px;
            }

            .subtitle {
                font-size: 1.1rem;
                margin-bottom: 1rem;
                line-height: 1.4;
            }

            .button {
                padding: 12px 24px;
                font-size: 1rem;
            }

            #carvingSetupContainer {
                flex-direction: column;
                align-items: center;
                gap: 15px; /* Adjust gap for vertical layout */
            }

            #carvingSetupContainer > canvas#carvingCanvas {
                width: 90%; /* Allow canvas to take more width */
                max-width: 300px; /* But not more than its defined resolution */
                height: auto; /* Maintain aspect ratio */
            }

            #carvingSetupContainer > div { /* Container of precisionMeter */
                margin-left: 0; /* Reset margin for vertical stacking */
                margin-top: 15px;
            }

            #precisionMeter {
                width: 25px; /* Slightly smaller */
                height: 150px;
            }

            #combatArena {
                width: 90%;
                height: auto;
                aspect-ratio: 4 / 3;
                max-width: 400px; /* Respect original max size if screen is wide enough */
            }

            #bossArena {
                width: 90%;
                height: auto;
                aspect-ratio: 5 / 4;
                max-width: 500px; /* Respect original max size */
            }

            #speedTrack {
                height: 120px; /* Was 100px */
            }
            
            .runner {
                 width: 40px; /* Adjust runner size for mobile */
                 height: 40px;
                 font-size: 22px; /* Adjust emoji size for mobile */
            }

            #chippableRockContainer {
                width: 220px;
                height: 220px;
            }

            #chippableRock {
                font-size: 4.5rem; /* Adjust emoji size */
            }

            #level2Doors .door {
                width: 100px; /* Slightly smaller doors if screen is very narrow */
                height: 160px;
                font-size: 2.5rem;
            }

            #rock { /* Mobile specific styles for the rock */
                width: 50vw; /* Responsive width for mobile */
                height: auto; /* Maintain aspect ratio */
                max-width: 240px; /* Cap at desktop size */
                max-height: 200px; /* Cap at desktop size */
                bottom: 30%; /* Adjust position for better centering with new size */
                left: 50%;
                transform: translateX(-50%);
                right: auto; /* Override desktop positioning */
            }
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <div id="gameScreen">
            <!-- Main Menu -->
            <div id="mainMenu" class="screen active">
                <div class="title">The Trial of Precision</div>
                <div class="subtitle">A journey of precision, choice, and sacrifice</div>
                <button class="button" onclick="startGame()">Begin Your Trial</button>
            </div>
            
            <!-- Level 1: Precision Carving -->
            <div id="level1Intro" class="screen">
                <div class="title">Level 1: The Trial of Precision</div>
                <div class="subtitle">Approach the rock. Carve with precision—do not smash.</div>
                <button class="button" onclick="showLevel1()">Enter the Cave</button>
            </div>
            
            <div id="level1Game" class="screen">
                <div class="ui-info">Click the rock to begin carving</div>
                <div class="ui-inventory" id="level1Inventory">Keys: 0</div>
                <div id="player"></div>
                <img id="rock" src="rock.png" alt="Carvable Rock" onclick="startCarving()">
                <div id="interactionPrompt">Press to carve</div>
            </div>
            
            <div id="carvingGame" class="screen">
                <div class="subtitle">Trace the key shape carefully</div>
                <div id="carvingSetupContainer" style="display: flex; align-items: center; gap: 20px;">
                    <canvas id="carvingCanvas" width="300" height="225"></canvas>
                    <div>
                        <div id="precisionMeter">
                            <div id="precisionFill"></div>
                        </div>
                        <div style="margin-top: 20px; color: #d4af37;">Precision</div>
                    </div>
                </div>
                <div style="margin-top: 20px;">
                    <div class="progress-bar">
                        <div id="carvingProgress" class="progress-fill" style="width: 0%;"></div>
                    </div>
                    <div>Progress: <span id="progressText">0%</span></div>
                </div>
            </div>
            
            <!-- Level 2: The Great Choice -->
            <div id="level2Intro" class="screen">
                <div class="title">Level 2: The Great Choice</div>
                <div class="subtitle">Two paths lie before you. Choose wisely.</div>
                <button class="button" onclick="showLevel2()">Enter the Chamber</button>
            </div>
            
            <div id="level2Doors" class="screen">
                <div class="ui-inventory">Keys: 1 <img src="key.png" alt="Key" class="key-image-style"></div>
                <div id="leftDoor" class="door drifting-door" onclick="chooseDoor('left')">
                    💀
                    <div class="door-handle"></div>
                </div>
                <div id="rightDoor" class="door drifting-door" onclick="chooseDoor('right')">
                    🌿
                    <div class="door-handle"></div>
                </div>
            </div>
            
            <div id="badChoice" class="screen">
                <div class="title" style="color: #dc143c;">You Have Chosen Poorly</div>
                <div class="subtitle">The path ends in darkness and despair.</div>
                <button class="button" onclick="showLevel2()">Try Again</button>
                <button class="button" onclick="showMainMenu()">Return to Menu</button>
            </div>
            
            <!-- Level 3: Triple Trials -->
            <div id="level3Intro" class="screen">
                <div class="title">Level 3: The Good World</div>
                <div class="subtitle">Welcome, chosen one. Prove your worth through three trials.</div>
                <button class="button" onclick="showLevel3Hub()">Enter the Trials</button>
            </div>
            
            <div id="level3Hub" class="screen">
                <div class="title">Choose Your Trial</div>
                <div class="subtitle" style="margin-bottom: 1rem;">Win all trials to go to the next level</div>
                <img id="level3HubImage" src="trophy.png" alt="Trials Trophy" style="margin-bottom: 1rem;">
                <div style="margin: 10px 0 20px 0;">Completed: <span id="trialsCompleted">0</span>/3</div>
                <div class="trials-container">
                    <div id="speedTrialButton" class="trial" onclick="startSpeedTrial()">
                        <img src="speedRacer.png" alt="Speed Icon" class="trial-icon-image" style="transform: scaleX(-1);"> <!-- Assuming speedRacer.png faces right, flip for left-facing racer -->
                        <div class="trial-name">Speed Trial</div>
                    </div>
                    <div id="strengthTrialButton" class="trial" onclick="startStrengthTrial()">
                        <img src="sword.png" alt="Strength Icon" class="trial-icon-image">
                        <div class="trial-name">Strength Trial</div>
                    </div>
                    <div id="swordTrialButton" class="trial" onclick="startSwordTrial()">
                        <img src="giant.png" alt="Giant Icon" class="trial-icon-image">
                        <div class="trial-name">Giant Duel</div>
                    </div>
                </div>
                <button id="proceedLevel4" class="button" onclick="showLevel4Intro()" style="display: none; margin-top: 30px;">
                    Proceed to Final Trial
                </button>
            </div>
            
            <!-- Speed Trial -->
            <div id="speedTrial" class="screen">
                <div class="title">Speed Trial</div>
                <div class="subtitle">Race against the Speed Demon! Press any key or tap the screen repeatedly!</div>
                <div id="speedTrack">
                    <div id="playerRunner" class="runner">🏃‍♂️</div>
                    <div id="npcRunner" class="runner">😈</div>
                </div>
                <button id="raceButton" class="button" onclick="startRace()">Start Race!</button>
                <button class="button secondary" onclick="showLevel3Hub()">Return to Hub</button>
            </div>
            
            <!-- Strength Trial -->
            <div id="strengthTrial" class="screen">
                <div class="title">Strength Trial</div>
                <div class="subtitle">Defeat all enemies to prove your might!</div>
                <div id="strengthTrialInfo">Wave: <span id="currentWave">1</span>/3 | Enemies: <span id="enemiesLeft">3</span></div>
                <div id="combatArena">
                    <div id="playerCombat">🛡️</div>
                </div>
                <button id="startCombat" class="button" onclick="startCombat()">Begin Combat!</button>
                <button class="button secondary" onclick="showLevel3Hub()">Return to Hub</button>
            </div>
            
            <!-- Sword Duel -->
            <div id="swordDuel" class="screen">
                <div class="title">Giant Sword Duel</div>
                <div class="subtitle">Collect swords and defeat the Stone Titan!</div>
                
                <div id="giantHealthDisplayArea">
                    <div id="giantStatus">
                        Giant Health: <span id="giantHealthText">5</span>/5 | Swords Collected: <span id="swordsCollectedText">0</span>
                    </div>
                </div>

                <div id="bossArena">
                    <div id="giant"><img src="giant.png" alt="Stone Titan"></div>
                </div>
                <button id="startBoss" class="button" onclick="startBossFight()">Enter Arena!</button>
                <button class="button secondary" onclick="showLevel3Hub()">Return to Hub</button>
            </div>
            
            <!-- Level 4: Sacrifice & Final -->
            <div id="level4Intro" class="screen">
                <div class="title">Level 4: The Final Sacrifice</div>
                <div class="subtitle">To forge the ultimate key, you must sacrifice what you have earned.</div>
                <button class="button" onclick="showAltarScreen()">Approach the Altar</button>
            </div>
            
            <div id="level4Altar" class="screen">
                <div class="title">Sacred Altar</div>
                <div class="subtitle">Place your collected swords upon the altar.<br>Their sacrifice will bind the essence of the Ultimate Key into a sacred stone.</div>
                <div class="ui-inventory">Swords Available: <span id="swordCount">0</span> <img src="sword.png" alt="Sword" class="sword-image-style large"></div>
                <div id="altar" onclick="performSacrifice()">🔥 Altar of Transformation</div>
                <div style="margin-top: 20px; font-size: 14px; opacity: 0.8;">
                    Click the altar to sacrifice your swords.
                </div>
            </div>
            
            <div id="level4RockChipping" class="screen">
                <div class="title">The Key Within</div>
                <div class="subtitle">The Ultimate Key is encased in this sacred stone. Click to chip away at it!</div>
                <div id="chippableRockContainer" style="position: relative; width: 200px; height: 200px; margin: 20px auto;">
                    <div id="chippableRock">🗿</div>
                    <div id="rockChippingProgress" class="progress-bar" style="position: absolute; bottom: -30px; left: 50%; transform: translateX(-50%); width: 100%;">
                        <div id="rockChippingFill" class="progress-fill" style="width: 0%;"></div>
                    </div>
                </div>
                <div id="rockChippingMessage" style="margin-top: 30px; font-size: 1rem; color: #d4af37;"></div>
            </div>
            
            <div id="finalDoorScreen" class="screen">
                <div class="title">The Gateway to Paradise</div>
                <div class="subtitle">Use your ultimate key to unlock eternal bliss</div>
                <div id="finalDoor" onclick="openFinalDoor()">
                    🚪
                    <div style="font-size: 1rem; margin-top: 20px;">The Ultimate Door</div>
                    <div id="finalDoorKeySlot"><img src="key.png" alt="Ultimate Key" class="key-image-style"></div>
                </div>
            </div>
            
            <!-- Victory -->
            <div id="paradise" class="screen">
                <div class="title" style="color: #065f46;">Paradise Achieved!</div>
                <div class="paradise-text">
                    🌟 Congratulations, noble seeker! 🌟<br>
                    Through precision, wise choice, earned strength, and willing sacrifice,<br>
                    you have transcended to the realm of eternal bliss.
                </div>
                <div class="paradise-text">
                    Your journey taught you that true rewards come not from taking,<br>
                    but from giving up what you have earned for something greater.
                </div>
                <button class="button" onclick="showMainMenu()" style="background: linear-gradient(45deg, #065f46, #047857);">
                    Begin New Journey
                </button>
            </div>
        </div>
    </div>

    <script>
        // Game State
        let gameState = {
            currentScreen: 'mainMenu',
            hasKey: false,
            trialsCompleted: 0,
            completedTrials: new Set(),
            swords: 0,
            finalKeyObtained: false
        };

        // Screen Management
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
            gameState.currentScreen = screenId;
        }

        function startGame() {
            showScreen('level1Intro');
        }

        function showMainMenu() {
            gameState = {
                currentScreen: 'mainMenu',
                hasKey: false,
                trialsCompleted: 0,
                completedTrials: new Set(),
                swords: 0,
                finalKeyObtained: false
            };
            showScreen('mainMenu');
        }

        // Level 1: Precision Carving
        function showLevel1() {
            showScreen('level1Game');
            document.getElementById('interactionPrompt').style.opacity = '1';
        }

        let isCarving = false;
        let carvingPath = [];
        let keyTemplate = [];
        let precision = 0;

        function startCarving() {
            showScreen('carvingGame');
            initializeCarvingGame();
        }

        function initializeCarvingGame() {
            const canvas = document.getElementById('carvingCanvas');
            const ctx = canvas.getContext('2d');
            
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Scaled key drawing (original 400x300, new 300x225, scale = 0.75)
            const s = 0.75;
            ctx.strokeStyle = '#ffd700';
            ctx.lineWidth = 3 * s; // Scale line width too for proportion
            ctx.beginPath();
            // Key shaft
            ctx.moveTo(50 * s, 150 * s);
            ctx.lineTo(300 * s, 150 * s);
            // Key head (circle)
            ctx.arc(50 * s, 150 * s, 30 * s, 0, 2 * Math.PI);
            // Key teeth
            ctx.moveTo(300 * s, 150 * s);
            ctx.lineTo(300 * s, 130 * s);
            ctx.moveTo(300 * s, 150 * s);
            ctx.lineTo(300 * s, 170 * s);
            ctx.moveTo(280 * s, 150 * s);
            ctx.lineTo(280 * s, 140 * s);
            ctx.stroke();
            
            // Set up key template points for precision checking (scaled)
            keyTemplate = [
                {x: 50*s, y: 150*s}, {x: 100*s, y: 150*s}, {x: 150*s, y: 150*s}, 
                {x: 200*s, y: 150*s}, {x: 250*s, y: 150*s}, {x: 300*s, y: 150*s}
            ];
            
            carvingPath = [];
            precision = 0;
            isCarving = false;
            
            // Add mouse events
            canvas.addEventListener('mousedown', startCarvingStroke);
            canvas.addEventListener('mousemove', continueCarvingStroke);
            canvas.addEventListener('mouseup', endCarvingStroke);
            // Add touch events
            canvas.addEventListener('touchstart', startCarvingStroke, { passive: false });
            canvas.addEventListener('touchmove', continueCarvingStroke, { passive: false });
            canvas.addEventListener('touchend', endCarvingStroke);
        }

        function getEventPosition(e) {
            const rect = e.target.getBoundingClientRect();
            let clientX, clientY;
            if (e.touches && e.touches.length > 0) {
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            } else {
                clientX = e.clientX;
                clientY = e.clientY;
            }
            return { x: clientX - rect.left, y: clientY - rect.top };
        }

        function startCarvingStroke(e) {
            if (e.type === 'touchstart') e.preventDefault(); // Prevent scrolling on touch
            isCarving = true;
            const pos = getEventPosition(e);
            carvingPath.push(pos);
            
            const ctx = e.target.getContext('2d');
            ctx.strokeStyle = '#ffffff';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(pos.x, pos.y);
        }

        function continueCarvingStroke(e) {
            if (!isCarving) return;
            if (e.type === 'touchmove') e.preventDefault(); // Prevent scrolling on touch
            
            const pos = getEventPosition(e);
            carvingPath.push(pos);
            
            const ctx = e.target.getContext('2d');
            ctx.lineTo(pos.x, pos.y);
            ctx.stroke();
            
            calculatePrecision();
        }

        function endCarvingStroke(e) {
            // No e.preventDefault() needed for touchend generally
            isCarving = false;
            checkCarvingCompletion();
        }

        function calculatePrecision() {
            if (carvingPath.length === 0) return;

            let closePoints = 0;
            const s = 0.75; // Scale factor based on new canvas size (300/400)
            const threshold = Math.round(25 * s); // Scaled threshold, was 25, now ~19

            // A more robust solution would check distance to line segments of the template
            // For this version, we simplify by checking proximity to key points of the template (scaled)
            for (const pathPoint of carvingPath) {
                let onTemplate = false;
                // Check against a simplified representation of the key template (scaled)
                const simplifiedTemplate = [
                    {x: 50*s, y: 150*s}, {x: 100*s, y: 150*s}, {x: 150*s, y: 150*s}, 
                    {x: 200*s, y: 150*s}, {x: 250*s, y: 150*s}, {x: 300*s, y: 150*s}, // Shaft
                    {x: 50*s, y: 120*s}, {x: 50*s, y: 180*s}, // Part of head (approx from arc r=30*s around 50*s,150*s)
                    {x: 300*s, y: 130*s}, {x: 300*s, y: 170*s}, {x:280*s, y:140*s} // Teeth
                ];

                for (const templatePoint of simplifiedTemplate) { 
                    const dist = Math.sqrt(Math.pow(pathPoint.x - templatePoint.x, 2) + Math.pow(pathPoint.y - templatePoint.y, 2));
                    if (dist < threshold) {
                        onTemplate = true;
                        break;
                    }
                }
                if (onTemplate) {
                    closePoints++;
                }
            }

            precision = (closePoints / carvingPath.length) * 100;
            
            const precisionFill = document.getElementById('precisionFill');
            precisionFill.style.height = `${Math.min(100, precision)}%`;

            if (precision < 33) precisionFill.style.background = 'linear-gradient(to top, #ff4444, #ff6666)';
            else if (precision < 66) precisionFill.style.background = 'linear-gradient(to top, #ffff44, #ffff66)';
            else precisionFill.style.background = 'linear-gradient(to top, #44ff44, #66ff66)';

            document.getElementById('progressText').textContent = `${Math.round(precision)}%`;
            // Approximation of carving progress based on path length vs an arbitrary estimate of full path length
            // This could be improved by measuring against the actual template length
            const estimatedFullPathLength = Math.round(400 * s); // Scaled, was 400, now 300
            document.getElementById('carvingProgress').style.width = `${Math.min(100, (carvingPath.length / estimatedFullPathLength) * 100)}%`; 
        }

        function checkCarvingCompletion() {
            const successThreshold = 50; 
            const progressThreshold = 60; 
            
            const currentProgress = parseFloat(document.getElementById('carvingProgress').style.width) || 0;

            const canvas = document.getElementById('carvingCanvas');
            // Remove mouse event listeners
            canvas.removeEventListener('mousedown', startCarvingStroke);
            canvas.removeEventListener('mousemove', continueCarvingStroke);
            canvas.removeEventListener('mouseup', endCarvingStroke);
            // Remove touch event listeners
            canvas.removeEventListener('touchstart', startCarvingStroke);
            canvas.removeEventListener('touchmove', continueCarvingStroke);
            canvas.removeEventListener('touchend', endCarvingStroke);

            if (precision >= successThreshold && currentProgress >= progressThreshold) {
                gameState.hasKey = true;
                document.getElementById('level1Inventory').innerHTML = "Keys: 1 <img src='key.png' alt='Key' class='key-image-style'>";
                alert("Key Obtained!"); 
                setTimeout(() => {
                    showScreen('level2Intro');
                }, 1500);
            } else {
                alert("Carving Failed. The key was destroyed. Try again.");
                setTimeout(() => {
                    showScreen('level1Game'); 
                    initializeCarvingGame(); 
                }, 2000);
            }
        }

        // Level 2: The Great Choice
        function showLevel2() {
            if (gameState.hasKey) {
                showScreen('level2Doors');
                document.querySelector('#level2Doors .ui-inventory').innerHTML = "Keys: 1 <img src='key.png' alt='Key' class='key-image-style'>";
                // Start door movement logic
                startDynamicDoorMovement(); 
            } else {
                alert("You need the key from Level 1!");
                showScreen('level1Intro');
            }
        }

        let doorMovementInterval;
        function startDynamicDoorMovement() {
            const doorsScreen = document.getElementById('level2Doors');
            const leftDoor = document.getElementById('leftDoor');
            const rightDoor = document.getElementById('rightDoor');
            const screenWidth = doorsScreen.offsetWidth;
            const screenHeight = doorsScreen.offsetHeight;
            const doorWidth = leftDoor.offsetWidth;
            const doorHeight = leftDoor.offsetHeight;

            // Initial random positions
            positionDoorRandomly(leftDoor, screenWidth, screenHeight, doorWidth, doorHeight);
            positionDoorRandomly(rightDoor, screenWidth, screenHeight, doorWidth, doorHeight);

            // Clear any existing interval
            if (doorMovementInterval) clearInterval(doorMovementInterval);

            doorMovementInterval = setInterval(() => {
                positionDoorRandomly(leftDoor, screenWidth, screenHeight, doorWidth, doorHeight);
                positionDoorRandomly(rightDoor, screenWidth, screenHeight, doorWidth, doorHeight);
            }, 3000); // Reposition every 3 seconds, adjust as needed
        }

        function positionDoorRandomly(doorElement, screenWidth, screenHeight, doorWidth, doorHeight) {
            // Ensure doors don't go too far off-screen or overlap too much with UI inventory
            const maxX = screenWidth - doorWidth - 20; // 20px buffer
            const maxY = screenHeight - doorHeight - 70; // 70px buffer for UI inventory at top
            const minX = 20;
            const minY = 70; // Start below inventory

            let newX = Math.random() * (maxX - minX) + minX;
            let newY = Math.random() * (maxY - minY) + minY;
            
            // Prevent doors from overlapping each other too much initially - basic check
            // This is a simple check; more complex logic might be needed for perfect avoidance
            const otherDoor = doorElement.id === 'leftDoor' ? document.getElementById('rightDoor') : document.getElementById('leftDoor');
            if (otherDoor) {
                const otherX = parseFloat(otherDoor.style.left);
                const otherY = parseFloat(otherDoor.style.top);
                if (Math.abs(newX - otherX) < doorWidth && Math.abs(newY - otherY) < doorHeight) {
                    // If too close, try to shift new position slightly
                    newX += doorWidth * (Math.random() < 0.5 ? 1 : -1);
                    newX = Math.max(minX, Math.min(maxX, newX)); // Clamp within bounds
                }
            }

            doorElement.style.left = newX + 'px';
            doorElement.style.top = newY + 'px';
        }

        function chooseDoor(door) {
            if (doorMovementInterval) clearInterval(doorMovementInterval); // Stop movement when choice is made
            if (!gameState.hasKey) {
                alert("The doors are sealed. You need a key.");
                return;
            }

            if (door === 'left') {
                // Bad choice - Ominous red door
                createFloatingText("A chilling premonition...", document.getElementById('leftDoor'), true);
                setTimeout(() => {
                    showScreen('badChoice'); 
                }, 1500);
            } else if (door === 'right') {
                // Good choice - Gentle green door
                createFloatingText("A sense of peace washes over you...", document.getElementById('rightDoor'));
                // Player makes the right choice, proceed to Level 3
                setTimeout(() => {
                    showScreen('level3Intro');
                }, 1500);
            } else {
                // Should not happen with current UI
                console.error("Invalid door choice");
            }
            // Key is used up
            gameState.hasKey = false;
            // Update inventory displays across relevant screens if they show key count
            document.getElementById('level1Inventory').innerHTML = "Keys: 0";
            document.querySelector('#level2Doors .ui-inventory').innerHTML = "Keys: 0";
        }

        // Level 3: Triple Trials
        function showLevel3Hub() {
            showScreen('level3Hub');
            document.getElementById('trialsCompleted').textContent = gameState.trialsCompleted;
            // Visually update completed trials
            gameState.completedTrials.forEach(trialId => {
                const button = document.getElementById(`${trialId}Button`);
                if (button) {
                    button.classList.add('completed');
                    button.onclick = null; // Disable button for completed trial
                    button.style.cursor = 'default';
                }
            });
            if (gameState.trialsCompleted === 3) {
                document.getElementById('proceedLevel4').style.display = 'block';
            } else {
                document.getElementById('proceedLevel4').style.display = 'none';
            }
        }

        function startSpeedTrial() {
            if (gameState.completedTrials.has('speedTrial')) return;
            showScreen('speedTrial');
            // Initialize speed trial elements if necessary
            document.getElementById('raceButton').disabled = false;
            document.getElementById('playerRunner').style.left = '0%';
            document.getElementById('npcRunner').style.left = '0%';
        }

        function startStrengthTrial() {
            if (gameState.completedTrials.has('strengthTrial')) return;
            showScreen('strengthTrial');
            // Initialize strength trial elements if necessary
            document.getElementById('startCombat').disabled = false;
            // Reset wave/enemy counts in UI
            document.getElementById('currentWave').textContent = "1";
            document.getElementById('enemiesLeft').textContent = "3"; // Example starting count
        }

        function startSwordTrial() {
            if (gameState.completedTrials.has('swordTrial')) return;
            showScreen('swordDuel');
            // Initialize sword duel elements if necessary
            document.getElementById('startBoss').disabled = false;
            // Reset health/sword counts in UI
            document.getElementById('giantHealthText').textContent = "5";
            document.getElementById('swordsCollectedText').textContent = "0";
        }

        // Speed Trial Logic
        let raceInterval;
        let playerPosition = 0;
        let npcPosition = 0;
        let isRacing = false;

        function startRace() {
            if (isRacing) return;
            isRacing = true;
            document.getElementById('raceButton').disabled = true;
            
            // Reset positions
            playerPosition = 0;
            npcPosition = 0;
            document.getElementById('playerRunner').style.left = '0%';
            document.getElementById('npcRunner').style.left = '0%';
            
            // Add event listeners
            document.addEventListener('keydown', handleRaceKeydown);
            document.getElementById('speedTrack').addEventListener('touchstart', handleRaceInput, { passive: false });
            
            // Start NPC movement
            raceInterval = setInterval(updateRace, 50);
            
            // Start the countdown
            createFloatingText("3...", document.getElementById('speedTrack'));
            setTimeout(() => {
                createFloatingText("2...", document.getElementById('speedTrack'));
                setTimeout(() => {
                    createFloatingText("1...", document.getElementById('speedTrack'));
                    setTimeout(() => {
                        createFloatingText("GO! Press any key repeatedly!", document.getElementById('speedTrack'));
                    }, 1000);
                }, 1000);
            }, 1000);
        }

        // Combined input handler for key presses and taps
        function handleRaceInput(e) {
            if (!isRacing) return;
            
            // Prevent default touch behavior like scrolling if it's a touch event
            if (e && e.type === 'touchstart') {
                e.preventDefault();
            }

            // Move player forward
            playerPosition += 3; 
            document.getElementById('playerRunner').style.left = `${playerPosition}%`;
            
            // Check win condition
            if (playerPosition >= 95) {
                endRace(true);
            }
        }

        function handleRaceKeydown(e) {
            // Allow escape to still be processed for other potential uses, otherwise trigger race input
            if (e.key === 'Escape') return; 
            handleRaceInput(); // Pass no event, as it's a keydown
        }

        function updateRace() {
            if (!isRacing) return;
            
            // Move NPC slower
            npcPosition += 0.8; // Reduced from 1 to make it easier
            document.getElementById('npcRunner').style.left = `${npcPosition}%`;
            
            // NPC wins if reaches end first
            if (npcPosition >= 95) {
                endRace(false);
            }
        }

        function endRace(playerWon) {
            isRacing = false;
            clearInterval(raceInterval);
            // Remove event listeners
            document.removeEventListener('keydown', handleRaceKeydown);
            document.getElementById('speedTrack').removeEventListener('touchstart', handleRaceInput);
            
            if (playerWon) {
                createFloatingText("Victory! You've outrun the Speed Demon!", document.getElementById('speedTrack'));
                if (!gameState.completedTrials.has('speedTrial')) {
                    gameState.completedTrials.add('speedTrial');
                    gameState.trialsCompleted++;
                    document.getElementById('speedTrialButton').classList.add('completed');
                }
                setTimeout(() => showLevel3Hub(), 2000);
            } else {
                createFloatingText("Too slow! Try again!", document.getElementById('speedTrack'));
                setTimeout(() => {
                    document.getElementById('raceButton').disabled = false;
                    document.getElementById('playerRunner').style.left = '0%';
                    document.getElementById('npcRunner').style.left = '0%';
                }, 2000);
            }
        }

        // Strength Trial Logic
        let currentWave = 1;
        let enemiesRemaining = 0;
        let enemySpawnInterval;
        let isCombatActive = false;
        let playerHealth = 100;

        function startCombat() {
            if (isCombatActive) return;
            document.getElementById('startCombat').disabled = true;
            isCombatActive = true;
            currentWave = 1;
            playerHealth = 100;
            
            const arena = document.getElementById('combatArena');

            // Add/update player health bar
            let playerHealthBar = document.getElementById('playerHealthBar');
            if (!playerHealthBar) {
                playerHealthBar = document.createElement('div');
                playerHealthBar.id = 'playerHealthBar';
                arena.appendChild(playerHealthBar);
            }
            playerHealthBar.style.position = 'absolute';
            playerHealthBar.style.bottom = '10px'; // Position at the bottom of the arena
            playerHealthBar.style.left = '50%';
            playerHealthBar.style.transform = 'translateX(-50%)'; // Center it
            playerHealthBar.style.width = '80%'; // Make it wide
            playerHealthBar.style.height = '20px';
            playerHealthBar.style.background = '#333';
            playerHealthBar.style.border = '2px solid #d4af37';
            playerHealthBar.style.borderRadius = '5px';
            playerHealthBar.innerHTML = '<div id="healthFill" style="width: 100%; height: 100%; background: linear-gradient(90deg, #ff4444, #44ff44, #44ff44); border-radius: 3px;"></div>';
            // Ensure healthFill is also reset
            document.getElementById('healthFill').style.width = '100%';

            startWave();
        }

        function startWave() {
            enemiesRemaining = currentWave + 2; // 3, 4, 5 enemies per wave
            document.getElementById('currentWave').textContent = currentWave;
            document.getElementById('enemiesLeft').textContent = enemiesRemaining;
            
            // Clear any existing enemies
            const existingEnemies = document.querySelectorAll('.enemy');
            existingEnemies.forEach(enemy => enemy.remove());
            
            // Start spawning enemies
            spawnEnemy();
            enemySpawnInterval = setInterval(() => {
                if (enemiesRemaining > 0) {
                    spawnEnemy();
                }
            }, 2000);

            // Add click handler for combat arena
            const arena = document.getElementById('combatArena');
            arena.addEventListener('click', handleCombatClick);
        }

        function spawnEnemy() {
            const arena = document.getElementById('combatArena');
            const enemy = document.createElement('div');
            enemy.className = 'enemy';
            
            // Random position along arena edges
            const side = Math.floor(Math.random() * 4);
            switch(side) {
                case 0: // Top
                    enemy.style.top = '0';
                    enemy.style.left = Math.random() * 90 + '%';
                    break;
                case 1: // Right
                    enemy.style.right = '0';
                    enemy.style.top = Math.random() * 90 + '%';
                    break;
                case 2: // Bottom
                    enemy.style.bottom = '0';
                    enemy.style.left = Math.random() * 90 + '%';
                    break;
                case 3: // Left
                    enemy.style.left = '0';
                    enemy.style.top = Math.random() * 90 + '%';
                    break;
            }
            
            arena.appendChild(enemy);
            moveEnemyTowardsPlayer(enemy);
        }

        function moveEnemyTowardsPlayer(enemy) {
            const moveInterval = setInterval(() => {
                if (!enemy.isConnected) {
                    clearInterval(moveInterval);
                    return;
                }

                const player = document.getElementById('playerCombat');
                const playerRect = player.getBoundingClientRect();
                const enemyRect = enemy.getBoundingClientRect();
                
                // Calculate direction to player
                const dx = playerRect.left - enemyRect.left;
                const dy = playerRect.top - enemyRect.top;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance < 40) { // Collision with player
                    damagePlayer();
                    enemy.remove();
                    updateEnemyCount();
                } else {
                    // Move enemy towards player
                    const speed = 2;
                    const vx = (dx / distance) * speed;
                    const vy = (dy / distance) * speed;
                    
                    enemy.style.left = (enemyRect.left - enemy.parentElement.getBoundingClientRect().left + vx) + 'px';
                    enemy.style.top = (enemyRect.top - enemy.parentElement.getBoundingClientRect().top + vy) + 'px';
                }
            }, 50);
        }

        function handleCombatClick(e) {
            if (!isCombatActive) return;
            
            const arena = document.getElementById('combatArena');
            const arenaRect = arena.getBoundingClientRect();
            const clickX = e.clientX - arenaRect.left;
            const clickY = e.clientY - arenaRect.top;
            
            // Create sword slash effect
            const slash = document.createElement('div');
            slash.style.position = 'absolute';
            slash.style.left = (clickX - 25) + 'px';
            slash.style.top = (clickY - 25) + 'px';
            slash.style.width = '50px';
            slash.style.height = '50px';
            slash.style.background = 'radial-gradient(circle, rgba(255,215,0,0.8) 0%, rgba(255,215,0,0) 70%)';
            slash.style.borderRadius = '50%';
            arena.appendChild(slash);
            
            // Remove slash effect after animation
            setTimeout(() => slash.remove(), 300);
            
            // Check for enemy hits
            const enemies = document.querySelectorAll('.enemy');
            enemies.forEach(enemy => {
                const enemyRect = enemy.getBoundingClientRect();
                const enemyX = enemyRect.left - arenaRect.left + enemyRect.width / 2;
                const enemyY = enemyRect.top - arenaRect.top + enemyRect.height / 2;
                
                const distance = Math.sqrt(
                    Math.pow(enemyX - clickX, 2) + 
                    Math.pow(enemyY - clickY, 2)
                );
                
                if (distance < 50) { // Hit radius
                    enemy.remove();
                    createSparkle(enemyX, enemyY, 8, '#ff4444');
                    updateEnemyCount();
                }
            });
        }

        function updateEnemyCount() {
            enemiesRemaining--;
            document.getElementById('enemiesLeft').textContent = enemiesRemaining;
            
            if (enemiesRemaining <= 0) {
                clearInterval(enemySpawnInterval);
                if (currentWave < 3) {
                    currentWave++;
                    setTimeout(() => {
                        createFloatingText(`Wave ${currentWave} incoming!`, document.getElementById('combatArena'));
                        startWave();
                    }, 1500);
                } else {
                    // Trial completed
                    endCombat(true);
                }
            }
        }

        function damagePlayer() {
            playerHealth -= 20;
            document.getElementById('healthFill').style.width = `${playerHealth}%`;
            
            if (playerHealth <= 0) {
                endCombat(false);
            }
        }

        function endCombat(victory) {
            isCombatActive = false;
            clearInterval(enemySpawnInterval);
            
            const arena = document.getElementById('combatArena');
            arena.removeEventListener('click', handleCombatClick);
            
            const enemies = document.querySelectorAll('.enemy');
            enemies.forEach(enemy => enemy.remove());
            
            const playerHealthBar = document.getElementById('playerHealthBar');
            if (playerHealthBar) playerHealthBar.remove(); // Remove on end
            
            if (victory) {
                createFloatingText("Victory! Your strength is proven!", arena);
                if (!gameState.completedTrials.has('strengthTrial')) {
                    gameState.completedTrials.add('strengthTrial');
                    gameState.trialsCompleted++;
                    document.getElementById('strengthTrialButton').classList.add('completed');
                }
                setTimeout(() => showLevel3Hub(), 2000);
            } else {
                createFloatingText("Defeated! Try again!", arena);
                setTimeout(() => {
                    document.getElementById('startCombat').disabled = false;
                    // Resetting for next attempt, numerical health will be set by startSwordTrial or startBossFight
                    document.getElementById('currentWave').textContent = "1";
                    document.getElementById('enemiesLeft').textContent = "3";
                }, 2000);
            }
        }

        // Sword Duel Logic
        let isDueling = false;
        let swordsCollected = 0;
        let giantHealth = 5;
        let swordSpawnInterval;
        let bossAttackInterval;
        let playerDuelHealth = 100;

        function startBossFight() {
            if (isDueling) return;
            document.getElementById('startBoss').disabled = true;
            isDueling = true;
            swordsCollected = 0;
            giantHealth = 5;
            playerDuelHealth = 100;
            
            const arena = document.getElementById('bossArena');
            const healthDisplayArea = document.getElementById('giantHealthDisplayArea');

            // Add player health bar (remains inside arena, bottom-left)
            let playerHealthBar = document.getElementById('duelPlayerHealth');
            if (!playerHealthBar) {
                playerHealthBar = document.createElement('div');
                playerHealthBar.id = 'duelPlayerHealth';
                arena.appendChild(playerHealthBar); 
            }
            playerHealthBar.style.position = 'absolute';
            playerHealthBar.style.bottom = '15px';
            playerHealthBar.style.left = '15px';
            playerHealthBar.style.width = '200px';
            playerHealthBar.style.height = '20px';
            playerHealthBar.style.background = '#333';
            playerHealthBar.style.border = '2px solid #d4af37';
            playerHealthBar.innerHTML = '<div id="duelHealthFill" style="width: 100%; height: 100%; background: linear-gradient(90deg, #ff4444, #44ff44);"></div>';
            
            // Create/manage giant's health hearts in the dedicated display area
            let heartsContainer = document.getElementById('giantHealthHearts');
            if (!heartsContainer) {
                heartsContainer = document.createElement('div');
                heartsContainer.id = 'giantHealthHearts';
                healthDisplayArea.appendChild(heartsContainer); // Append to the area ABOVE arena
            } else {
                 // If it exists but somehow not in healthDisplayArea, move it.
                if(heartsContainer.parentElement !== healthDisplayArea) {
                    healthDisplayArea.appendChild(heartsContainer);
                }
            }
            heartsContainer.innerHTML = ''; // Clear previous hearts
            
            for (let i = 0; i < 5; i++) {
                const heartSpan = document.createElement('span');
                heartSpan.textContent = '❤️';
                heartSpan.classList.add('heart');
                heartsContainer.appendChild(heartSpan);
            }

            // Update UI text
            document.getElementById('swordsCollectedText').textContent = swordsCollected;
            updateGiantHealthDisplay();
            
            spawnSword();
            swordSpawnInterval = setInterval(spawnSword, 3000);
            bossAttackInterval = setInterval(bossAttack, 2000);
            arena.addEventListener('click', handleDuelClick);
            updateGiantAttackable();
        }

        function updateGiantHealthDisplay() {
            // Update hearts
            const heartsContainer = document.getElementById('giantHealthHearts');
            if (heartsContainer) {
                const heartElements = heartsContainer.children;
                for (let i = 0; i < heartElements.length; i++) {
                    if (i < giantHealth) {
                        heartElements[i].classList.remove('empty');
                    } else {
                        heartElements[i].classList.add('empty');
                    }
                }
            }
            // Update text
            const healthText = document.getElementById('giantHealthText');
            if (healthText) {
                healthText.textContent = giantHealth;
            }
        }

        function spawnSword() {
            const arena = document.getElementById('bossArena');
            const swordPickupDiv = document.createElement('div');
            swordPickupDiv.className = 'sword-pickup';
            // swordPickupDiv.textContent = '⚔️'; /* Remove emoji text */
            
            const swordImg = document.createElement('img');
            swordImg.src = 'sword.png';
            swordImg.alt = 'Sword Pickup';
            swordImg.className = 'sword-pickup-image'; // Apply specific style if needed or use general one
            swordPickupDiv.appendChild(swordImg);
            
            let x, y;
            do {
                x = Math.random() * 80 + 10; 
                y = Math.random() * 80 + 10; 
            } while (isNearGiant(x, y));
            
            swordPickupDiv.style.left = x + '%';
            swordPickupDiv.style.top = y + '%';
            
            swordPickupDiv.addEventListener('click', () => collectSword(swordPickupDiv));
            arena.appendChild(swordPickupDiv);
            
            setTimeout(() => {
                if (swordPickupDiv.isConnected) {
                    swordPickupDiv.remove();
                }
            }, 5000);
        }

        function isNearGiant(x, y) {
            // Check if position is too close to giant (center of arena)
            const distance = Math.sqrt(
                Math.pow(x - 50, 2) + 
                Math.pow(y - 50, 2)
            );
            return distance < 30; // Within 30% of arena size
        }

        function collectSword(sword) {
            if (!isDueling) return;
            
            sword.remove();
            swordsCollected++;
            document.getElementById('swordsCollectedText').textContent = swordsCollected;
            createFloatingText("+1 Sword!", sword);
            createSparkle(
                sword.offsetLeft + sword.offsetWidth / 2,
                sword.offsetTop + sword.offsetHeight / 2,
                10,
                '#ffd700'
            );
            
            // Update giant's appearance
            updateGiantAttackable();
        }

        function updateGiantAttackable() {
            const giant = document.getElementById('giant');
            if (swordsCollected > 0) {
                giant.classList.add('attackable');
            } else {
                giant.classList.remove('attackable');
            }
        }

        function bossAttack() {
            if (!isDueling) return;
            
            const arena = document.getElementById('bossArena');
            const giant = document.getElementById('giant');
            
            giant.style.transform = 'scale(1.2)';
            setTimeout(() => giant.style.transform = '', 300);
            
            const shockwave = document.createElement('div');
            shockwave.style.position = 'absolute';
            shockwave.style.left = '50%';
            shockwave.style.top = '50%';
            shockwave.style.transform = 'translate(-50%, -50%)';
            shockwave.style.width = '0';
            shockwave.style.height = '0';
            shockwave.style.border = '2px solid #ff4444';
            shockwave.style.borderRadius = '50%';
            shockwave.style.animation = 'shockwave 1s ease-out forwards';
            arena.appendChild(shockwave);
            
            if (!document.querySelector('#shockwaveStyle')) {
                const style = document.createElement('style');
                style.id = 'shockwaveStyle';
                style.textContent = `
                    @keyframes shockwave {
                        0% { width: 0; height: 0; opacity: 1; }
                        100% { width: 300px; height: 300px; opacity: 0; }
                    }
                `;
                document.head.appendChild(style);
            }
            
            setTimeout(() => {
                if (!isDueling) return;
                const playerRect = document.getElementById('duelPlayerHealth').getBoundingClientRect();
                const giantRect = giant.getBoundingClientRect();
                const distance = Math.sqrt(
                    Math.pow(playerRect.left - giantRect.left, 2) +
                    Math.pow(playerRect.top - giantRect.top, 2)
                );
                
                if (distance < 150) { 
                    damagePlayer();
                }
                
                shockwave.remove();
            }, 500);
        }

        function handleDuelClick(e) {
            if (!isDueling || swordsCollected <= 0) return;
            
            const arena = document.getElementById('bossArena');
            const arenaRect = arena.getBoundingClientRect();
            const giant = document.getElementById('giant');
            const giantRect = giant.getBoundingClientRect();
            
            const clickX = e.clientX - arenaRect.left;
            const clickY = e.clientY - arenaRect.top;
            const giantX = giantRect.left - arenaRect.left + giantRect.width / 2;
            const giantY = giantRect.top - arenaRect.top + giantRect.height / 2;
            
            const distance = Math.sqrt(
                Math.pow(giantX - clickX, 2) +
                Math.pow(giantY - clickY, 2)
            );
            
            if (distance < 100) { // Hit radius
                swordsCollected--;
                document.getElementById('swordsCollectedText').textContent = swordsCollected;
                
                giant.style.backgroundColor = '#ff4444';
                setTimeout(() => giant.style.backgroundColor = '', 200);
                
                createSparkle(giantX, giantY, 15, '#ff4444');
                
                giantHealth--;
                updateGiantHealthDisplay(); 
                
                updateGiantAttackable();
                
                if (giantHealth <= 0) {
                    endDuel(true);
                }
            }
        }

        function damagePlayer() {
            playerDuelHealth -= 25;
            document.getElementById('duelHealthFill').style.width = `${playerDuelHealth}%`;
            
            if (playerDuelHealth <= 0) {
                endDuel(false);
            }
        }

        function endDuel(victory) {
            isDueling = false;
            clearInterval(swordSpawnInterval);
            clearInterval(bossAttackInterval);
            
            const arena = document.getElementById('bossArena');
            arena.removeEventListener('click', handleDuelClick);
            document.querySelectorAll('.sword-pickup').forEach(sword => sword.remove());
            
            const playerHealthBar = document.getElementById('duelPlayerHealth');
            if(playerHealthBar) playerHealthBar.remove();
            
            if (victory) {
                createFloatingText("The Stone Titan falls!", arena);
                if (!gameState.completedTrials.has('swordTrial')) {
                    gameState.completedTrials.add('swordTrial');
                    gameState.trialsCompleted++;
                    document.getElementById('swordTrialButton').classList.add('completed');
                }
                setTimeout(() => showLevel3Hub(), 2000);
            } else {
                createFloatingText("Defeated! Try again!", arena);
                setTimeout(() => {
                    document.getElementById('startBoss').disabled = false;
                    // Resetting for next attempt, numerical health will be set by startSwordTrial or startBossFight
                    document.getElementById('swordsCollectedText').textContent = "0"; 
                }, 2000);
            }
        }

        // Level 4: Sacrifice & Transformation
        function showLevel4Intro() {
            if (gameState.trialsCompleted === 3) {
                showScreen('level4Intro');
            } else {
                alert("You must complete all three trials first!");
                showLevel3Hub();
            }
        }

        function showAltarScreen() {
            showScreen('level4Altar');
            gameState.swords = gameState.trialsCompleted; 
            document.getElementById('swordCount').textContent = gameState.swords;
        }

        function performSacrifice() {
            if (gameState.swords > 0) {
                createFloatingText(`${gameState.swords} sword(s) sacrificed! The sacred stone appears.`, document.getElementById('altar'));
                gameState.swords = 0; 
                document.getElementById('swordCount').textContent = gameState.swords;
                
                setTimeout(() => {
                    showScreen('level4RockChipping');
                    initializeRockChippingGame(); 
                }, 2000);
            } else {
                alert("You have no swords to sacrifice. Complete more trials.");
                showLevel3Hub(); 
            }
        }

        // Level 4 Rock Chipping Logic
        let rockHealth = 50; // Number of clicks to reveal key
        const maxRockHealth = 50;

        function initializeRockChippingGame() {
            rockHealth = 50;
            document.getElementById('chippableRock').textContent = '🗿'; // Initial rock appearance
            document.getElementById('chippableRock').style.fontSize = '5rem';
            document.getElementById('rockChippingFill').style.width = '0%';
            document.getElementById('rockChippingMessage').textContent = 'Click the rock!';
            
            const rockElement = document.getElementById('chippableRock');
            // Remove old listeners if any, then add new one
            rockElement.replaceWith(rockElement.cloneNode(true));
            document.getElementById('chippableRock').addEventListener('click', handleRockClick);
        }

        function handleRockClick(event) {
            if (gameState.finalKeyObtained) return;

            rockHealth--;
            const progress = ((maxRockHealth - rockHealth) / maxRockHealth) * 100;
            document.getElementById('rockChippingFill').style.width = `${progress}%`;

            const rockElement = document.getElementById('chippableRock');
            const rockContainer = document.getElementById('chippableRockContainer');

            const rockRect = rockElement.getBoundingClientRect();
            const containerRect = rockContainer.getBoundingClientRect();
            for (let i = 0; i < 3; i++) { 
                const chip = document.createElement('div');
                chip.className = 'rock-chip';
                const clickX = event.clientX - containerRect.left;
                const clickY = event.clientY - containerRect.top;
                chip.style.left = `${clickX + (Math.random() - 0.5) * 20 - 5}px`;
                chip.style.top = `${clickY + (Math.random() - 0.5) * 20 - 5}px`;
                chip.style.setProperty('--tx', `${(Math.random() - 0.5) * 100}px`);
                chip.style.setProperty('--ty', `${(Math.random() - 0.5) * 100 - 50}px`);
                rockContainer.appendChild(chip);
                setTimeout(() => chip.remove(), 500);
            }

            if (rockHealth <= 0) {
                gameState.finalKeyObtained = true;
                rockElement.innerHTML = '<img src="key.png" alt="Ultimate Key" class="key-image-style">'; // Reveal key image
                document.getElementById('rockChippingMessage').textContent = 'The Ultimate Key is yours!';
                createFloatingText("Ultimate Key Obtained!", rockElement);
                rockElement.replaceWith(rockElement.cloneNode(true)); 

                setTimeout(() => {
                    showScreen('finalDoorScreen');
                }, 2000);
            } else if (rockHealth < maxRockHealth * 0.33) {
                rockElement.textContent = '🧱'; 
                document.getElementById('rockChippingMessage').textContent = 'Almost there!';
            } else if (rockHealth < maxRockHealth * 0.66) {
                rockElement.textContent = '🪨'; 
                document.getElementById('rockChippingMessage').textContent = 'Keep going!';
            }
        }

        function openFinalDoor() {
            if (gameState.finalKeyObtained) { // Check for finalKeyObtained
                createFloatingText("The final door creaks open... revealing paradise!", document.getElementById('finalDoor'));
                setTimeout(() => {
                    showScreen('paradise');
                }, 2000);
            } else {
                alert("The door is sealed by an ancient power. You need the Ultimate Key.");
                showScreen('level4RockChipping'); 
            }
        }

        // UI Helper Functions
        function createFloatingText(text, element, isError = false) {
            const floatingText = document.createElement('div');
            floatingText.classList.add('floating-text');
            floatingText.textContent = text;
            if (isError) {
                floatingText.style.color = '#ff6b6b'; // Error color
            }
            
            const rect = element.getBoundingClientRect();
            const gameContainerRect = document.getElementById('gameContainer').getBoundingClientRect();
            
            // Position text near the element, adjusting for container offset
            floatingText.style.left = `${rect.left - gameContainerRect.left + rect.width / 2}px`;
            floatingText.style.top = `${rect.top - gameContainerRect.top - 30}px`; // Position above element
            floatingText.style.transform = 'translateX(-50%)'; // Center align

            document.getElementById('gameScreen').appendChild(floatingText);
            
            setTimeout(() => {
                floatingText.remove();
            }, 2000); // Remove after 2 seconds
        }

        function createSparkle(x, y, count = 5, color = '#ffd700') {
            const gameScreen = document.getElementById('gameScreen');
            for (let i = 0; i < count; i++) {
                const particle = document.createElement('div');
                particle.classList.add('particle');
                particle.style.background = color;
                particle.style.left = `${x + (Math.random() - 0.5) * 30}px`;
                particle.style.top = `${y + (Math.random() - 0.5) * 30}px`;
                gameScreen.appendChild(particle);
                setTimeout(() => particle.remove(), 1000);
            }
        }

    </script>
</body>
</html>
            
            